/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Color } from 'tns-core-modules/color';
import { ShapeEnum } from './shape.enum';
import { Length } from 'tns-core-modules/ui/page/page';
import { isAndroid, screen } from "tns-core-modules/platform";
let /** @type {?} */ LayeredShadow;
let /** @type {?} */ PlainShadow;
if (isAndroid) {
    LayeredShadow = android.graphics.drawable.LayerDrawable.extend({});
    PlainShadow = android.graphics.drawable.GradientDrawable.extend({});
}
export class Shadow {
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static apply(tnsView, data) {
        const /** @type {?} */ LOLLIPOP = 21;
        if (tnsView.android &&
            android.os.Build.VERSION.SDK_INT >= LOLLIPOP) {
            Shadow.applyOnAndroid(tnsView, Shadow.getDefaults(data));
        }
        else if (tnsView.ios) {
            Shadow.applyOnIOS(tnsView, Shadow.getDefaults(data));
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    static getDefaults(data) {
        return Object.assign({}, data, {
            shape: (/** @type {?} */ (data)).shape || Shadow.DEFAULT_SHAPE,
            pressedElevation: (/** @type {?} */ (data)).pressedElevation || Shadow.DEFAULT_PRESSED_ELEVATION,
            pressedTranslationZ: (/** @type {?} */ (data)).pressedTranslationZ || Shadow.DEFAULT_PRESSED_ELEVATION,
            shadowColor: (/** @type {?} */ (data)).shadowColor ||
                Shadow.DEFAULT_SHADOW_COLOR,
            useShadowPath: ((/** @type {?} */ (data)).useShadowPath !== undefined ? (/** @type {?} */ (data)).useShadowPath : true),
            rasterize: ((/** @type {?} */ (data)).rasterize !== undefined ? (/** @type {?} */ (data)).rasterize : false)
        });
    }
    /**
     * @param {?} drawable
     * @return {?}
     */
    static isShadow(drawable) {
        return (drawable instanceof LayeredShadow || drawable instanceof PlainShadow);
    }
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static applyOnAndroid(tnsView, data) {
        const /** @type {?} */ nativeView = tnsView.android;
        let /** @type {?} */ shape;
        let /** @type {?} */ overrideBackground = true;
        let /** @type {?} */ currentBg = nativeView.getBackground();
        if (currentBg instanceof android.graphics.drawable.RippleDrawable) {
            // play nice if a ripple is wrapping a shadow
            let /** @type {?} */ rippleBg = currentBg.getDrawable(0);
            if (rippleBg instanceof android.graphics.drawable.InsetDrawable) {
                overrideBackground = false; // this is a button with it's own shadow
            }
            else if (Shadow.isShadow(rippleBg)) {
                // if the ripple is wrapping a shadow, strip it
                currentBg = rippleBg;
            }
        }
        if (overrideBackground) {
            if (Shadow.isShadow(currentBg)) {
                // make sure to have the right background
                currentBg = currentBg instanceof LayeredShadow ? // if layered, get the original background
                    currentBg.getDrawable(1) : null;
            }
            const /** @type {?} */ outerRadii = Array.create("float", 8);
            if (data.cornerRadius === undefined) {
                outerRadii[0] = outerRadii[1] = Length.toDevicePixels(tnsView.borderTopLeftRadius, 0);
                outerRadii[2] = outerRadii[3] = Length.toDevicePixels(tnsView.borderTopRightRadius, 0);
                outerRadii[4] = outerRadii[5] = Length.toDevicePixels(tnsView.borderBottomRightRadius, 0);
                outerRadii[6] = outerRadii[7] = Length.toDevicePixels(tnsView.borderBottomLeftRadius, 0);
            }
            else {
                java.util.Arrays.fill(outerRadii, Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.cornerRadius)));
            }
            // use the user defined color or the default in case the color is TRANSPARENT
            const /** @type {?} */ bgColor = currentBg ?
                (currentBg instanceof android.graphics.drawable.ColorDrawable && currentBg.getColor() ?
                    currentBg.getColor() : android.graphics.Color.parseColor(data.bgcolor || Shadow.DEFAULT_BGCOLOR)) :
                android.graphics.Color.parseColor(data.bgcolor || Shadow.DEFAULT_BGCOLOR);
            let /** @type {?} */ newBg;
            if (data.shape !== ShapeEnum.RECTANGLE || data.bgcolor || !currentBg) {
                // replace background
                shape = new PlainShadow();
                shape.setShape(android.graphics.drawable.GradientDrawable[data.shape]);
                shape.setCornerRadii(outerRadii);
                shape.setColor(bgColor);
                newBg = shape;
            }
            else {
                // add a layer
                const /** @type {?} */ r = new android.graphics.drawable.shapes.RoundRectShape(outerRadii, null, null);
                shape = new android.graphics.drawable.ShapeDrawable(r);
                shape.getPaint().setColor(bgColor);
                var /** @type {?} */ arr = Array.create(android.graphics.drawable.Drawable, 2);
                arr[0] = shape;
                arr[1] = currentBg;
                const /** @type {?} */ drawable = new LayeredShadow(arr);
                newBg = drawable;
            }
            nativeView.setBackgroundDrawable(newBg);
        }
        nativeView.setElevation(Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.elevation)));
        nativeView.setTranslationZ(Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.translationZ)));
        if (nativeView.getStateListAnimator() || data.forcePressAnimation) {
            this.overrideDefaultAnimator(nativeView, data);
        }
    }
    /**
     * @param {?} nativeView
     * @param {?} data
     * @return {?}
     */
    static overrideDefaultAnimator(nativeView, data) {
        const /** @type {?} */ sla = new android.animation.StateListAnimator();
        const /** @type {?} */ ObjectAnimator = android.animation.ObjectAnimator;
        const /** @type {?} */ AnimatorSet = android.animation.AnimatorSet;
        const /** @type {?} */ shortAnimTime = android.R.integer.config_shortAnimTime;
        const /** @type {?} */ buttonDuration = nativeView.getContext().getResources().getInteger(shortAnimTime) / 2;
        const /** @type {?} */ pressedElevation = this.androidDipToPx(nativeView, data.pressedElevation);
        const /** @type {?} */ pressedZ = this.androidDipToPx(nativeView, data.pressedTranslationZ);
        const /** @type {?} */ elevation = this.androidDipToPx(nativeView, data.elevation);
        const /** @type {?} */ z = this.androidDipToPx(nativeView, data.translationZ || 0);
        const /** @type {?} */ pressedSet = new AnimatorSet();
        const /** @type {?} */ notPressedSet = new AnimatorSet();
        const /** @type {?} */ defaultSet = new AnimatorSet();
        pressedSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [pressedZ])
                .setDuration(buttonDuration),
            ObjectAnimator.ofFloat(nativeView, "elevation", [pressedElevation])
                .setDuration(0),
        ]));
        notPressedSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [z])
                .setDuration(buttonDuration),
            ObjectAnimator.ofFloat(nativeView, "elevation", [elevation])
                .setDuration(0),
        ]));
        defaultSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [0]).setDuration(0),
            ObjectAnimator.ofFloat(nativeView, "elevation", [0]).setDuration(0),
        ]));
        sla.addState([android.R.attr.state_pressed, android.R.attr.state_enabled], pressedSet);
        sla.addState([android.R.attr.state_enabled], notPressedSet);
        sla.addState([], defaultSet);
        nativeView.setStateListAnimator(sla);
    }
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static applyOnIOS(tnsView, data) {
        const /** @type {?} */ nativeView = tnsView.ios;
        const /** @type {?} */ elevation = parseFloat(((/** @type {?} */ (data.elevation)) - 0).toFixed(2));
        nativeView.layer.maskToBounds = false;
        nativeView.layer.shadowColor = new Color(data.shadowColor).ios.CGColor;
        nativeView.layer.shadowOffset =
            data.shadowOffset ?
                CGSizeMake(0, parseFloat(String(data.shadowOffset))) :
                CGSizeMake(0, 0.54 * elevation - 0.14);
        nativeView.layer.shadowOpacity =
            data.shadowOpacity ?
                parseFloat(String(data.shadowOpacity)) :
                0.006 * elevation + 0.25;
        nativeView.layer.shadowRadius =
            data.shadowRadius ?
                parseFloat(String(data.shadowRadius)) :
                0.66 * elevation - 0.5;
        nativeView.layer.shouldRasterize = data.rasterize;
        nativeView.layer.rasterizationScale = screen.mainScreen.scale;
        let /** @type {?} */ shadowPath = null;
        if (data.useShadowPath) {
            shadowPath = UIBezierPath.bezierPathWithRoundedRectCornerRadius(nativeView.bounds, nativeView.layer.shadowRadius).cgPath;
        }
        nativeView.layer.shadowPath = shadowPath;
    }
    /**
     * @param {?} nativeView
     * @param {?} dip
     * @return {?}
     */
    static androidDipToPx(nativeView, dip) {
        const /** @type {?} */ metrics = nativeView.getContext().getResources().getDisplayMetrics();
        return android.util.TypedValue.applyDimension(android.util.TypedValue.COMPLEX_UNIT_DIP, dip, metrics);
    }
}
Shadow.DEFAULT_SHAPE = ShapeEnum.RECTANGLE;
Shadow.DEFAULT_BGCOLOR = '#FFFFFF';
Shadow.DEFAULT_SHADOW_COLOR = '#000000';
Shadow.DEFAULT_PRESSED_ELEVATION = 2;
Shadow.DEFAULT_PRESSED_Z = 4;
function Shadow_tsickle_Closure_declarations() {
    /** @type {?} */
    Shadow.DEFAULT_SHAPE;
    /** @type {?} */
    Shadow.DEFAULT_BGCOLOR;
    /** @type {?} */
    Shadow.DEFAULT_SHADOW_COLOR;
    /** @type {?} */
    Shadow.DEFAULT_PRESSED_ELEVATION;
    /** @type {?} */
    Shadow.DEFAULT_PRESSED_Z;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZG93LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmF0aXZlc2NyaXB0LW5neC1zaGFkb3cvIiwic291cmNlcyI6WyJuYXRpdmVzY3JpcHQtbmd4LXNoYWRvdy9jb21tb24vc2hhZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFJL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQVM5RCxxQkFBSSxhQUFhLENBQUM7QUFDbEIscUJBQUksV0FBVyxDQUFDO0FBRWhCLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDZCxhQUFhLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNuRSxXQUFXLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ3JFO0FBRUQsTUFBTTs7Ozs7O0lBT0osTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFZLEVBQUUsSUFBMkI7UUFDcEQsdUJBQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixFQUFFLENBQUMsQ0FDRCxPQUFPLENBQUMsT0FBTztZQUNmLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksUUFDdEMsQ0FBQyxDQUFDLENBQUM7WUFDRCxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDMUQ7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENB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TUFBTSxDQUFDLGNBQWMsQ0FBQyxVQUFlLEVBQUUsR0FBVztRQUNoRCx1QkFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDM0UsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FDM0MsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLEVBQ3hDLEdBQUcsRUFDSCxPQUFPLENBQ1IsQ0FBQztLQUNIOzt1QkE1THNCLFNBQVMsQ0FBQyxTQUFTO3lCQUNqQixTQUFTOzhCQUNKLFNBQVM7bUNBQ0osQ0FBQzsyQkFDVCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sb3IgfSBmcm9tICd0bnMtY29yZS1tb2R1bGVzL2NvbG9yJztcblxuaW1wb3J0IHsgQW5kcm9pZERhdGEgfSBmcm9tIFwiLi9hbmRyb2lkLWRhdGEubW9kZWxcIjtcbmltcG9ydCB7IElPU0RhdGEgfSBmcm9tIFwiLi9pb3MtZGF0YS5tb2RlbFwiO1xuaW1wb3J0IHsgU2hhcGVFbnVtIH0gZnJvbSAnLi9zaGFwZS5lbnVtJztcbmltcG9ydCB7IExlbmd0aCB9IGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvdWkvcGFnZS9wYWdlJztcbmltcG9ydCB7IGlzQW5kcm9pZCwgc2NyZWVuIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvcGxhdGZvcm1cIjtcblxuZGVjbGFyZSBjb25zdCBhbmRyb2lkOiBhbnk7XG5kZWNsYXJlIGNvbnN0IGphdmE6IGFueTtcbmRlY2xhcmUgY29uc3QgQ0dTaXplTWFrZTogYW55O1xuZGVjbGFyZSBjb25zdCBVSVNjcmVlbjogYW55O1xuZGVjbGFyZSBjb25zdCBBcnJheTogYW55O1xuZGVjbGFyZSBjb25zdCBVSUJlemllclBhdGg6IGFueTtcblxubGV0IExheWVyZWRTaGFkb3c7XG5sZXQgUGxhaW5TaGFkb3c7XG5cbmlmIChpc0FuZHJvaWQpIHtcbiAgTGF5ZXJlZFNoYWRvdyA9IGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuTGF5ZXJEcmF3YWJsZS5leHRlbmQoe30pO1xuICBQbGFpblNoYWRvdyA9IGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuR3JhZGllbnREcmF3YWJsZS5leHRlbmQoe30pO1xufVxuXG5leHBvcnQgY2xhc3MgU2hhZG93IHtcbiAgc3RhdGljIERFRkFVTFRfU0hBUEUgPSBTaGFwZUVudW0uUkVDVEFOR0xFO1xuICBzdGF0aWMgREVGQVVMVF9CR0NPTE9SID0gJyNGRkZGRkYnO1xuICBzdGF0aWMgREVGQVVMVF9TSEFET1dfQ09MT1IgPSAnIzAwMDAwMCc7XG4gIHN0YXRpYyBERUZBVUxUX1BSRVNTRURfRUxFVkFUSU9OID0gMjtcbiAgc3RhdGljIERFRkFVTFRfUFJFU1NFRF9aID0gNDtcblxuICBzdGF0aWMgYXBwbHkodG5zVmlldzogYW55LCBkYXRhOiBJT1NEYXRhIHwgQW5kcm9pZERhdGEpIHtcbiAgICBjb25zdCBMT0xMSVBPUCA9IDIxO1xuICAgIGlmIChcbiAgICAgIHRuc1ZpZXcuYW5kcm9pZCAmJlxuICAgICAgYW5kcm9pZC5vcy5CdWlsZC5WRVJTSU9OLlNES19JTlQgPj0gTE9MTElQT1BcbiAgICApIHtcbiAgICAgIFNoYWRvdy5hcHBseU9uQW5kcm9pZCh0bnNWaWV3LCBTaGFkb3cuZ2V0RGVmYXVsdHMoZGF0YSkpO1xuICAgIH0gZWxzZSBpZiAodG5zVmlldy5pb3MpIHtcbiAgICAgIFNoYWRvdy5hcHBseU9uSU9TKHRuc1ZpZXcsIFNoYWRvdy5nZXREZWZhdWx0cyhkYXRhKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0RGVmYXVsdHMoZGF0YTogSU9TRGF0YSB8IEFuZHJvaWREYXRhKSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIGRhdGEsXG4gICAgICB7XG4gICAgICAgIHNoYXBlOiAoZGF0YSBhcyBBbmRyb2lkRGF0YSkuc2hhcGUgfHwgU2hhZG93LkRFRkFVTFRfU0hBUEUsXG4gICAgICAgIHByZXNzZWRFbGV2YXRpb246IChkYXRhIGFzIEFuZHJvaWREYXRhKS5wcmVzc2VkRWxldmF0aW9uIHx8IFNoYWRvdy5ERUZBVUxUX1BSRVNTRURfRUxFVkFUSU9OLFxuICAgICAgICBwcmVzc2VkVHJhbnNsYXRpb25aOiAoZGF0YSBhcyBBbmRyb2lkRGF0YSkucHJlc3NlZFRyYW5zbGF0aW9uWiB8fCBTaGFkb3cuREVGQVVMVF9QUkVTU0VEX0VMRVZBVElPTixcbiAgICAgICAgc2hhZG93Q29sb3I6IChkYXRhIGFzIElPU0RhdGEpLnNoYWRvd0NvbG9yIHx8XG4gICAgICAgICAgU2hhZG93LkRFRkFVTFRfU0hBRE9XX0NPTE9SLFxuICAgICAgICB1c2VTaGFkb3dQYXRoOiAoKGRhdGEgYXMgSU9TRGF0YSkudXNlU2hhZG93UGF0aCAhPT0gdW5kZWZpbmVkID8gKGRhdGEgYXMgSU9TRGF0YSkudXNlU2hhZG93UGF0aCA6IHRydWUpLFxuICAgICAgICByYXN0ZXJpemU6ICgoZGF0YSBhcyBJT1NEYXRhKS5yYXN0ZXJpemUgIT09IHVuZGVmaW5lZCA/IChkYXRhIGFzIElPU0RhdGEpLnJhc3Rlcml6ZSA6IGZhbHNlKVxuICAgICAgfSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaXNTaGFkb3coZHJhd2FibGU6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoZHJhd2FibGUgaW5zdGFuY2VvZiBMYXllcmVkU2hhZG93IHx8IGRyYXdhYmxlIGluc3RhbmNlb2YgUGxhaW5TaGFkb3cpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgYXBwbHlPbkFuZHJvaWQodG5zVmlldzogYW55LCBkYXRhOiBBbmRyb2lkRGF0YSkge1xuICAgIGNvbnN0IG5hdGl2ZVZpZXcgPSB0bnNWaWV3LmFuZHJvaWQ7XG4gICAgbGV0IHNoYXBlO1xuICAgIGxldCBvdmVycmlkZUJhY2tncm91bmQgPSB0cnVlO1xuXG5cbiAgICBsZXQgY3VycmVudEJnID0gbmF0aXZlVmlldy5nZXRCYWNrZ3JvdW5kKCk7XG5cbiAgICBpZiAoY3VycmVudEJnIGluc3RhbmNlb2YgYW5kcm9pZC5ncmFwaGljcy5kcmF3YWJsZS5SaXBwbGVEcmF3YWJsZSkgeyAvLyBwbGF5IG5pY2UgaWYgYSByaXBwbGUgaXMgd3JhcHBpbmcgYSBzaGFkb3dcbiAgICAgIGxldCByaXBwbGVCZyA9IGN1cnJlbnRCZy5nZXREcmF3YWJsZSgwKTtcbiAgICAgIGlmIChyaXBwbGVCZyBpbnN0YW5jZW9mIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuSW5zZXREcmF3YWJsZSkge1xuICAgICAgICBvdmVycmlkZUJhY2tncm91bmQgPSBmYWxzZTsgLy8gdGhpcyBpcyBhIGJ1dHRvbiB3aXRoIGl0J3Mgb3duIHNoYWRvd1xuICAgICAgfSBlbHNlIGlmIChTaGFkb3cuaXNTaGFkb3cocmlwcGxlQmcpKSB7IC8vIGlmIHRoZSByaXBwbGUgaXMgd3JhcHBpbmcgYSBzaGFkb3csIHN0cmlwIGl0XG4gICAgICAgIGN1cnJlbnRCZyA9IHJpcHBsZUJnO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3ZlcnJpZGVCYWNrZ3JvdW5kKSB7XG4gICAgICBpZiAoU2hhZG93LmlzU2hhZG93KGN1cnJlbnRCZykpIHsgLy8gbWFrZSBzdXJlIHRvIGhhdmUgdGhlIHJpZ2h0IGJhY2tncm91bmRcbiAgICAgICAgY3VycmVudEJnID0gY3VycmVudEJnIGluc3RhbmNlb2YgTGF5ZXJlZFNoYWRvdyA/IC8vIGlmIGxheWVyZWQsIGdldCB0aGUgb3JpZ2luYWwgYmFja2dyb3VuZFxuICAgICAgICAgIGN1cnJlbnRCZy5nZXREcmF3YWJsZSgxKSA6IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG91dGVyUmFkaWkgPSBBcnJheS5jcmVhdGUoXCJmbG9hdFwiLCA4KTtcbiAgICAgIGlmIChkYXRhLmNvcm5lclJhZGl1cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG91dGVyUmFkaWlbMF0gPSBvdXRlclJhZGlpWzFdID0gTGVuZ3RoLnRvRGV2aWNlUGl4ZWxzKHRuc1ZpZXcuYm9yZGVyVG9wTGVmdFJhZGl1cywgMCk7XG4gICAgICAgIG91dGVyUmFkaWlbMl0gPSBvdXRlclJhZGlpWzNdID0gTGVuZ3RoLnRvRGV2aWNlUGl4ZWxzKHRuc1ZpZXcuYm9yZGVyVG9wUmlnaHRSYWRpdXMsIDApO1xuICAgICAgICBvdXRlclJhZGlpWzRdID0gb3V0ZXJSYWRpaVs1XSA9IExlbmd0aC50b0RldmljZVBpeGVscyh0bnNWaWV3LmJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzLCAwKTtcbiAgICAgICAgb3V0ZXJSYWRpaVs2XSA9IG91dGVyUmFkaWlbN10gPSBMZW5ndGgudG9EZXZpY2VQaXhlbHModG5zVmlldy5ib3JkZXJCb3R0b21MZWZ0UmFkaXVzLCAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGphdmEudXRpbC5BcnJheXMuZmlsbChvdXRlclJhZGlpLCBTaGFkb3cuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS5jb3JuZXJSYWRpdXMgYXMgbnVtYmVyKSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHVzZSB0aGUgdXNlciBkZWZpbmVkIGNvbG9yIG9yIHRoZSBkZWZhdWx0IGluIGNhc2UgdGhlIGNvbG9yIGlzIFRSQU5TUEFSRU5UXG4gICAgICBjb25zdCBiZ0NvbG9yID0gY3VycmVudEJnID9cbiAgICAgICAgKGN1cnJlbnRCZyBpbnN0YW5jZW9mIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuQ29sb3JEcmF3YWJsZSAmJiBjdXJyZW50QmcuZ2V0Q29sb3IoKSA/XG4gICAgICAgICAgY3VycmVudEJnLmdldENvbG9yKCkgOiBhbmRyb2lkLmdyYXBoaWNzLkNvbG9yLnBhcnNlQ29sb3IoZGF0YS5iZ2NvbG9yIHx8IFNoYWRvdy5ERUZBVUxUX0JHQ09MT1IpKSA6XG4gICAgICAgIGFuZHJvaWQuZ3JhcGhpY3MuQ29sb3IucGFyc2VDb2xvcihkYXRhLmJnY29sb3IgfHwgU2hhZG93LkRFRkFVTFRfQkdDT0xPUik7XG5cbiAgICAgIGxldCBuZXdCZztcblxuICAgICAgaWYgKGRhdGEuc2hhcGUgIT09IFNoYXBlRW51bS5SRUNUQU5HTEUgfHwgZGF0YS5iZ2NvbG9yIHx8ICFjdXJyZW50QmcpIHsgLy8gcmVwbGFjZSBiYWNrZ3JvdW5kXG4gICAgICAgIHNoYXBlID0gbmV3IFBsYWluU2hhZG93KCk7XG4gICAgICAgIHNoYXBlLnNldFNoYXBlKFxuICAgICAgICAgIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuR3JhZGllbnREcmF3YWJsZVtkYXRhLnNoYXBlXSxcbiAgICAgICAgKTtcbiAgICAgICAgc2hhcGUuc2V0Q29ybmVyUmFkaWkob3V0ZXJSYWRpaSk7XG4gICAgICAgIHNoYXBlLnNldENvbG9yKGJnQ29sb3IpO1xuICAgICAgICBuZXdCZyA9IHNoYXBlO1xuICAgICAgfSBlbHNlIHsgLy8gYWRkIGEgbGF5ZXJcbiAgICAgICAgY29uc3QgciA9IG5ldyBhbmRyb2lkLmdyYXBoaWNzLmRyYXdhYmxlLnNoYXBlcy5Sb3VuZFJlY3RTaGFwZShvdXRlclJhZGlpLCBudWxsLCBudWxsKTtcbiAgICAgICAgc2hhcGUgPSBuZXcgYW5kcm9pZC5ncmFwaGljcy5kcmF3YWJsZS5TaGFwZURyYXdhYmxlKHIpO1xuICAgICAgICBzaGFwZS5nZXRQYWludCgpLnNldENvbG9yKGJnQ29sb3IpO1xuICAgICAgICB2YXIgYXJyID0gQXJyYXkuY3JlYXRlKGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuRHJhd2FibGUsIDIpO1xuICAgICAgICBhcnJbMF0gPSBzaGFwZTtcbiAgICAgICAgYXJyWzFdID0gY3VycmVudEJnO1xuICAgICAgICBjb25zdCBkcmF3YWJsZSA9IG5ldyBMYXllcmVkU2hhZG93KGFycik7XG4gICAgICAgIG5ld0JnID0gZHJhd2FibGU7XG4gICAgICB9XG5cbiAgICAgIG5hdGl2ZVZpZXcuc2V0QmFja2dyb3VuZERyYXdhYmxlKG5ld0JnKTtcbiAgICB9XG5cbiAgICBuYXRpdmVWaWV3LnNldEVsZXZhdGlvbihcbiAgICAgIFNoYWRvdy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLmVsZXZhdGlvbiBhcyBudW1iZXIpLFxuICAgICk7XG4gICAgbmF0aXZlVmlldy5zZXRUcmFuc2xhdGlvblooXG4gICAgICBTaGFkb3cuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS50cmFuc2xhdGlvblogYXMgbnVtYmVyKSxcbiAgICApO1xuICAgIGlmIChuYXRpdmVWaWV3LmdldFN0YXRlTGlzdEFuaW1hdG9yKCkgfHwgZGF0YS5mb3JjZVByZXNzQW5pbWF0aW9uKSB7XG4gICAgICB0aGlzLm92ZXJyaWRlRGVmYXVsdEFuaW1hdG9yKG5hdGl2ZVZpZXcsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIG92ZXJyaWRlRGVmYXVsdEFuaW1hdG9yKG5hdGl2ZVZpZXc6IGFueSwgZGF0YTogQW5kcm9pZERhdGEpIHtcbiAgICBjb25zdCBzbGEgPSBuZXcgYW5kcm9pZC5hbmltYXRpb24uU3RhdGVMaXN0QW5pbWF0b3IoKTtcblxuICAgIGNvbnN0IE9iamVjdEFuaW1hdG9yID0gYW5kcm9pZC5hbmltYXRpb24uT2JqZWN0QW5pbWF0b3I7XG4gICAgY29uc3QgQW5pbWF0b3JTZXQgPSBhbmRyb2lkLmFuaW1hdGlvbi5BbmltYXRvclNldDtcbiAgICBjb25zdCBzaG9ydEFuaW1UaW1lID0gYW5kcm9pZC5SLmludGVnZXIuY29uZmlnX3Nob3J0QW5pbVRpbWU7XG5cbiAgICBjb25zdCBidXR0b25EdXJhdGlvbiA9XG4gICAgICBuYXRpdmVWaWV3LmdldENvbnRleHQoKS5nZXRSZXNvdXJjZXMoKS5nZXRJbnRlZ2VyKHNob3J0QW5pbVRpbWUpIC8gMjtcbiAgICBjb25zdCBwcmVzc2VkRWxldmF0aW9uID0gdGhpcy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLnByZXNzZWRFbGV2YXRpb24pO1xuICAgIGNvbnN0IHByZXNzZWRaID0gdGhpcy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLnByZXNzZWRUcmFuc2xhdGlvblopO1xuICAgIGNvbnN0IGVsZXZhdGlvbiA9IHRoaXMuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS5lbGV2YXRpb24pO1xuICAgIGNvbnN0IHogPSB0aGlzLmFuZHJvaWREaXBUb1B4KG5hdGl2ZVZpZXcsIGRhdGEudHJhbnNsYXRpb25aIHx8IDApO1xuXG4gICAgY29uc3QgcHJlc3NlZFNldCA9IG5ldyBBbmltYXRvclNldCgpO1xuICAgIGNvbnN0IG5vdFByZXNzZWRTZXQgPSBuZXcgQW5pbWF0b3JTZXQoKTtcbiAgICBjb25zdCBkZWZhdWx0U2V0ID0gbmV3IEFuaW1hdG9yU2V0KCk7XG5cbiAgICBwcmVzc2VkU2V0LnBsYXlUb2dldGhlcihqYXZhLnV0aWwuQXJyYXlzLmFzTGlzdChbXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwidHJhbnNsYXRpb25aXCIsIFtwcmVzc2VkWl0pXG4gICAgICAgIC5zZXREdXJhdGlvbihidXR0b25EdXJhdGlvbiksXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwiZWxldmF0aW9uXCIsIFtwcmVzc2VkRWxldmF0aW9uXSlcbiAgICAgICAgLnNldER1cmF0aW9uKDApLFxuICAgIF0pKTtcbiAgICBub3RQcmVzc2VkU2V0LnBsYXlUb2dldGhlcihqYXZhLnV0aWwuQXJyYXlzLmFzTGlzdChbXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwidHJhbnNsYXRpb25aXCIsIFt6XSlcbiAgICAgICAgLnNldER1cmF0aW9uKGJ1dHRvbkR1cmF0aW9uKSxcbiAgICAgIE9iamVjdEFuaW1hdG9yLm9mRmxvYXQobmF0aXZlVmlldywgXCJlbGV2YXRpb25cIiwgW2VsZXZhdGlvbl0pXG4gICAgICAgIC5zZXREdXJhdGlvbigwKSxcbiAgICBdKSk7XG4gICAgZGVmYXVsdFNldC5wbGF5VG9nZXRoZXIoamF2YS51dGlsLkFycmF5cy5hc0xpc3QoW1xuICAgICAgT2JqZWN0QW5pbWF0b3Iub2ZGbG9hdChuYXRpdmVWaWV3LCBcInRyYW5zbGF0aW9uWlwiLCBbMF0pLnNldER1cmF0aW9uKDApLFxuICAgICAgT2JqZWN0QW5pbWF0b3Iub2ZGbG9hdChuYXRpdmVWaWV3LCBcImVsZXZhdGlvblwiLCBbMF0pLnNldER1cmF0aW9uKDApLFxuICAgIF0pKTtcblxuICAgIHNsYS5hZGRTdGF0ZShcbiAgICAgIFthbmRyb2lkLlIuYXR0ci5zdGF0ZV9wcmVzc2VkLCBhbmRyb2lkLlIuYXR0ci5zdGF0ZV9lbmFibGVkXSxcbiAgICAgIHByZXNzZWRTZXQsXG4gICAgKTtcbiAgICBzbGEuYWRkU3RhdGUoW2FuZHJvaWQuUi5hdHRyLnN0YXRlX2VuYWJsZWRdLCBub3RQcmVzc2VkU2V0KTtcbiAgICBzbGEuYWRkU3RhdGUoW10sIGRlZmF1bHRTZXQpO1xuICAgIG5hdGl2ZVZpZXcuc2V0U3RhdGVMaXN0QW5pbWF0b3Ioc2xhKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGFwcGx5T25JT1ModG5zVmlldzogYW55LCBkYXRhOiBJT1NEYXRhKSB7XG4gICAgY29uc3QgbmF0aXZlVmlldyA9IHRuc1ZpZXcuaW9zO1xuICAgIGNvbnN0IGVsZXZhdGlvbiA9IHBhcnNlRmxvYXQoKChkYXRhLmVsZXZhdGlvbiBhcyBudW1iZXIpIC0gMCkudG9GaXhlZCgyKSk7XG4gICAgbmF0aXZlVmlldy5sYXllci5tYXNrVG9Cb3VuZHMgPSBmYWxzZTtcbiAgICBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd0NvbG9yID0gbmV3IENvbG9yKGRhdGEuc2hhZG93Q29sb3IpLmlvcy5DR0NvbG9yO1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93T2Zmc2V0ID1cbiAgICAgIGRhdGEuc2hhZG93T2Zmc2V0ID9cbiAgICAgICAgQ0dTaXplTWFrZSgwLCBwYXJzZUZsb2F0KFN0cmluZyhkYXRhLnNoYWRvd09mZnNldCkpKSA6XG4gICAgICAgIENHU2l6ZU1ha2UoMCwgMC41NCAqIGVsZXZhdGlvbiAtIDAuMTQpO1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93T3BhY2l0eSA9XG4gICAgICBkYXRhLnNoYWRvd09wYWNpdHkgP1xuICAgICAgICBwYXJzZUZsb2F0KFN0cmluZyhkYXRhLnNoYWRvd09wYWNpdHkpKSA6XG4gICAgICAgIDAuMDA2ICogZWxldmF0aW9uICsgMC4yNTtcbiAgICBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd1JhZGl1cyA9XG4gICAgICBkYXRhLnNoYWRvd1JhZGl1cyA/XG4gICAgICAgIHBhcnNlRmxvYXQoU3RyaW5nKGRhdGEuc2hhZG93UmFkaXVzKSkgOlxuICAgICAgICAwLjY2ICogZWxldmF0aW9uIC0gMC41O1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hvdWxkUmFzdGVyaXplID0gZGF0YS5yYXN0ZXJpemU7XG4gICAgbmF0aXZlVmlldy5sYXllci5yYXN0ZXJpemF0aW9uU2NhbGUgPSBzY3JlZW4ubWFpblNjcmVlbi5zY2FsZTtcbiAgICBsZXQgc2hhZG93UGF0aCA9IG51bGw7XG4gICAgaWYoZGF0YS51c2VTaGFkb3dQYXRoKSB7XG4gICAgICBzaGFkb3dQYXRoID0gVUlCZXppZXJQYXRoLmJlemllclBhdGhXaXRoUm91bmRlZFJlY3RDb3JuZXJSYWRpdXMobmF0aXZlVmlldy5ib3VuZHMsIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93UmFkaXVzKS5jZ1BhdGg7XG4gICAgfVxuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93UGF0aCA9IHNoYWRvd1BhdGg7XG4gIH1cblxuICBzdGF0aWMgYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldzogYW55LCBkaXA6IG51bWJlcikge1xuICAgIGNvbnN0IG1ldHJpY3MgPSBuYXRpdmVWaWV3LmdldENvbnRleHQoKS5nZXRSZXNvdXJjZXMoKS5nZXREaXNwbGF5TWV0cmljcygpO1xuICAgIHJldHVybiBhbmRyb2lkLnV0aWwuVHlwZWRWYWx1ZS5hcHBseURpbWVuc2lvbihcbiAgICAgIGFuZHJvaWQudXRpbC5UeXBlZFZhbHVlLkNPTVBMRVhfVU5JVF9ESVAsXG4gICAgICBkaXAsXG4gICAgICBtZXRyaWNzLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==